import{_ as a,c as i,o as n,a3 as e}from"./chunks/framework.5IuD8hAv.js";const c=JSON.parse('{"title":"Cloudflare 版本","description":"","frontmatter":{},"headers":[],"relativePath":"guide/cloudflare.md","filePath":"guide/cloudflare.md","lastUpdated":1764664473000}'),l={name:"guide/cloudflare.md"};function t(p,s,r,h,d,k){return n(),i("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1764664473000"},[...s[0]||(s[0]=[e(`<h1 id="cloudflare-版本" tabindex="-1">Cloudflare 版本 <a class="header-anchor" href="#cloudflare-版本" aria-label="Permalink to &quot;Cloudflare 版本&quot;">​</a></h1><p>HaloLight Cloudflare 版本基于 Next.js 15 App Router + React 19 构建，使用 <code>@opennextjs/cloudflare</code> 适配 Cloudflare Workers/Pages 边缘运行时，实现全球低延迟访问。</p><p><strong>在线预览</strong>：<a href="https://halolight-cloudflare.h7ml.cn/" target="_blank" rel="noreferrer">https://halolight-cloudflare.h7ml.cn/</a></p><p><strong>GitHub</strong>：<a href="https://github.com/halolight/halolight-cloudflare" target="_blank" rel="noreferrer">https://github.com/halolight/halolight-cloudflare</a></p><h2 id="与原版差异" tabindex="-1">与原版差异 <a class="header-anchor" href="#与原版差异" aria-label="Permalink to &quot;与原版差异&quot;">​</a></h2><table tabindex="0"><thead><tr><th>特性</th><th>原版 (Next.js)</th><th>Cloudflare 版</th></tr></thead><tbody><tr><td>Next.js</td><td>14.x</td><td>15.5.x</td></tr><tr><td>React</td><td>18.x</td><td>19.x</td></tr><tr><td>运行时</td><td>Node.js (Vercel)</td><td>Cloudflare Workers (Edge)</td></tr><tr><td>部署平台</td><td>Vercel / Docker</td><td>Cloudflare Pages</td></tr><tr><td>开发工具</td><td>webpack</td><td>Turbopack</td></tr><tr><td>部署命令</td><td><code>pnpm build &amp;&amp; pnpm start</code></td><td><code>pnpm deploy</code></td></tr><tr><td>SSR 位置</td><td>服务器/Serverless</td><td>全球边缘节点</td></tr><tr><td>冷启动</td><td>取决于平台</td><td>&lt; 50ms</td></tr></tbody></table><h2 id="技术栈" tabindex="-1">技术栈 <a class="header-anchor" href="#技术栈" aria-label="Permalink to &quot;技术栈&quot;">​</a></h2><table tabindex="0"><thead><tr><th>技术</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>Next.js</td><td>15.5.x</td><td>React 全栈框架</td></tr><tr><td>React</td><td>19.x</td><td>UI 库</td></tr><tr><td>TypeScript</td><td>5.x</td><td>类型安全</td></tr><tr><td>Tailwind CSS</td><td>4.x</td><td>原子化 CSS</td></tr><tr><td>@opennextjs/cloudflare</td><td>1.x</td><td>Cloudflare 适配层</td></tr><tr><td>Wrangler</td><td>4.x</td><td>Cloudflare CLI</td></tr><tr><td>shadcn/ui</td><td>latest</td><td>UI 组件库</td></tr><tr><td>Zustand</td><td>5.x</td><td>状态管理</td></tr><tr><td>TanStack Query</td><td>5.x</td><td>服务端状态</td></tr><tr><td>Vitest</td><td>4.x</td><td>单元测试</td></tr><tr><td>Mock.js</td><td>1.x</td><td>数据模拟</td></tr></tbody></table><h2 id="目录结构" tabindex="-1">目录结构 <a class="header-anchor" href="#目录结构" aria-label="Permalink to &quot;目录结构&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>halolight-cloudflare/</span></span>
<span class="line"><span>├── src/</span></span>
<span class="line"><span>│   ├── app/                      # App Router 页面</span></span>
<span class="line"><span>│   │   ├── (dashboard)/          # 管理后台路由组</span></span>
<span class="line"><span>│   │   ├── (auth)/               # 认证路由组</span></span>
<span class="line"><span>│   │   ├── (legal)/              # 法律条款路由组</span></span>
<span class="line"><span>│   │   ├── layout.tsx            # 根布局</span></span>
<span class="line"><span>│   │   └── page.tsx              # 首页</span></span>
<span class="line"><span>│   ├── components/               # React 组件</span></span>
<span class="line"><span>│   │   ├── ui/                   # shadcn/ui 组件</span></span>
<span class="line"><span>│   │   ├── layout/               # 布局组件</span></span>
<span class="line"><span>│   │   └── dashboard/            # 仪表盘组件</span></span>
<span class="line"><span>│   ├── hooks/                    # React Hooks</span></span>
<span class="line"><span>│   ├── stores/                   # Zustand Stores</span></span>
<span class="line"><span>│   ├── lib/                      # 工具库</span></span>
<span class="line"><span>│   ├── mock/                     # Mock 数据</span></span>
<span class="line"><span>│   ├── providers/                # Context Providers</span></span>
<span class="line"><span>│   ├── config/                   # 配置文件</span></span>
<span class="line"><span>│   └── __tests__/                # 单元测试</span></span>
<span class="line"><span>├── public/                       # 静态资源</span></span>
<span class="line"><span>├── .github/workflows/            # GitHub Actions CI</span></span>
<span class="line"><span>├── .open-next/                   # OpenNext 构建产物（自动生成）</span></span>
<span class="line"><span>├── coverage/                     # 测试覆盖率（自动生成）</span></span>
<span class="line"><span>├── cloudflare-env.d.ts           # Cloudflare 环境类型</span></span>
<span class="line"><span>├── vitest.config.ts              # Vitest 测试配置</span></span>
<span class="line"><span>├── open-next.config.ts           # OpenNext 配置</span></span>
<span class="line"><span>├── wrangler.jsonc                # Wrangler 配置</span></span>
<span class="line"><span>├── next.config.ts                # Next.js 配置</span></span>
<span class="line"><span>└── package.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to &quot;快速开始&quot;">​</a></h2><h3 id="环境要求" tabindex="-1">环境要求 <a class="header-anchor" href="#环境要求" aria-label="Permalink to &quot;环境要求&quot;">​</a></h3><ul><li>Node.js &gt;= 18</li><li>pnpm &gt;= 8</li><li>Wrangler CLI (需登录 Cloudflare)</li></ul><h3 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/halolight/halolight-cloudflare.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> halolight-cloudflare</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="环境变量" tabindex="-1">环境变量 <a class="header-anchor" href="#环境变量" aria-label="Permalink to &quot;环境变量&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .dev.vars.example</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .dev.vars</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .dev.vars 示例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_API_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/api</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_MOCK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_APP_TITLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">HaloLight</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_BRAND_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">HaloLight</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_DEMO_EMAIL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">admin@halolight.h7ml.cn</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NEXT_PUBLIC_DEMO_PASSWORD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Admin@123</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="启动开发" tabindex="-1">启动开发 <a class="header-anchor" href="#启动开发" aria-label="Permalink to &quot;启动开发&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>访问 <a href="http://localhost:3000" target="_blank" rel="noreferrer">http://localhost:3000</a></p><h3 id="本地预览-edge-环境" tabindex="-1">本地预览 (Edge 环境) <a class="header-anchor" href="#本地预览-edge-环境" aria-label="Permalink to &quot;本地预览 (Edge 环境)&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preview</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>模拟 Cloudflare Workers 环境，检测 Edge Runtime 兼容性问题。</p><h3 id="部署到-cloudflare" tabindex="-1">部署到 Cloudflare <a class="header-anchor" href="#部署到-cloudflare" aria-label="Permalink to &quot;部署到 Cloudflare&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrangler</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 首次需要登录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 构建并部署</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="常用脚本" tabindex="-1">常用脚本 <a class="header-anchor" href="#常用脚本" aria-label="Permalink to &quot;常用脚本&quot;">​</a></h2><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 启动开发服务器（Turbopack，Node.js 环境）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Next.js 生产构建</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preview</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 本地预览 Cloudflare 环境</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 部署到 Cloudflare</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upload</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 仅上传不部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lint</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # ESLint 检查</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> type-check</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # TypeScript 类型检查</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # 运行单元测试（watch 模式）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:run</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 运行单元测试（单次）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:coverage</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 运行测试并生成覆盖率报告</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cf-typegen</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 生成 Cloudflare 环境类型</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="edge-runtime-约束" tabindex="-1">Edge Runtime 约束 <a class="header-anchor" href="#edge-runtime-约束" aria-label="Permalink to &quot;Edge Runtime 约束&quot;">​</a></h2><p>Cloudflare Workers 是边缘运行时，部分 Node.js API 不可用：</p><p><strong>不可用的 API</strong>：</p><ul><li><code>fs</code> - 文件系统操作</li><li><code>child_process</code> - 子进程</li><li><code>net</code>、<code>dgram</code> - 原生网络套接字</li><li><code>crypto.createCipher</code> 等旧加密 API</li></ul><p><strong>部分可用</strong> (通过 nodejs_compat)：</p><ul><li><code>Buffer</code> - 二进制数据处理</li><li><code>process.env</code> - 环境变量</li><li><code>crypto</code> 部分 API - 如 <code>randomUUID()</code></li></ul><div class="warning custom-block"><p class="custom-block-title">注意</p><p>使用 <code>@opennextjs/cloudflare</code> 时，整个应用自动运行在边缘环境，无需手动声明 <code>export const runtime = &#39;edge&#39;</code>。</p></div><h2 id="cloudflare-服务集成" tabindex="-1">Cloudflare 服务集成 <a class="header-anchor" href="#cloudflare-服务集成" aria-label="Permalink to &quot;Cloudflare 服务集成&quot;">​</a></h2><h3 id="可用服务" tabindex="-1">可用服务 <a class="header-anchor" href="#可用服务" aria-label="Permalink to &quot;可用服务&quot;">​</a></h3><table tabindex="0"><thead><tr><th>服务</th><th>用途</th><th>说明</th></tr></thead><tbody><tr><td>KV</td><td>键值存储</td><td>全球分布式缓存</td></tr><tr><td>D1</td><td>SQLite 数据库</td><td>边缘 SQL 数据库</td></tr><tr><td>R2</td><td>对象存储</td><td>S3 兼容存储</td></tr><tr><td>Queues</td><td>消息队列</td><td>异步任务处理</td></tr><tr><td>Durable Objects</td><td>有状态对象</td><td>实时协作</td></tr><tr><td>Workers AI</td><td>AI 推理</td><td>边缘 AI 模型</td></tr></tbody></table><h3 id="使用示例" tabindex="-1">使用示例 <a class="header-anchor" href="#使用示例" aria-label="Permalink to &quot;使用示例&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { getRequestContext } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@opennextjs/cloudflare&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getRequestContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MY_KV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;key&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ value });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="配置-kv-存储" tabindex="-1">配置 KV 存储 <a class="header-anchor" href="#配置-kv-存储" aria-label="Permalink to &quot;配置 KV 存储&quot;">​</a></h3><div class="language-jsonc vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">jsonc</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// wrangler.jsonc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;kv_namespaces&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;binding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MY_KV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="配置-d1-数据库" tabindex="-1">配置 D1 数据库 <a class="header-anchor" href="#配置-d1-数据库" aria-label="Permalink to &quot;配置 D1 数据库&quot;">​</a></h3><div class="language-jsonc vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">jsonc</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// wrangler.jsonc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;d1_databases&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;binding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MY_DB&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;database_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="ssr-ssg-isr-支持" tabindex="-1">SSR/SSG/ISR 支持 <a class="header-anchor" href="#ssr-ssg-isr-支持" aria-label="Permalink to &quot;SSR/SSG/ISR 支持&quot;">​</a></h2><table tabindex="0"><thead><tr><th>渲染模式</th><th>支持状态</th><th>说明</th></tr></thead><tbody><tr><td>SSR</td><td>✅ 支持</td><td>每次请求在边缘渲染</td></tr><tr><td>SSG</td><td>✅ 支持</td><td>构建时生成静态页面</td></tr><tr><td>ISR</td><td>⚠️ 部分</td><td>需配置 R2 缓存</td></tr></tbody></table><h3 id="启用-isr" tabindex="-1">启用 ISR <a class="header-anchor" href="#启用-isr" aria-label="Permalink to &quot;启用 ISR&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// open-next.config.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineCloudflareConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@opennextjs/cloudflare&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r2IncrementalCache </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@opennextjs/cloudflare/overrides/incremental-cache/r2-incremental-cache&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineCloudflareConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  incrementalCache: r2IncrementalCache,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="ci-cd" tabindex="-1">CI/CD <a class="header-anchor" href="#ci-cd" aria-label="Permalink to &quot;CI/CD&quot;">​</a></h2><p>项目已配置完整的 GitHub Actions CI 工作流：</p><table tabindex="0"><thead><tr><th>Job</th><th>说明</th></tr></thead><tbody><tr><td><strong>lint</strong></td><td>ESLint + TypeScript 类型检查</td></tr><tr><td><strong>test</strong></td><td>Vitest 单元测试 + Codecov 覆盖率</td></tr><tr><td><strong>build</strong></td><td>OpenNext Cloudflare 生产构建</td></tr><tr><td><strong>security</strong></td><td>依赖安全审计</td></tr><tr><td><strong>dependency-review</strong></td><td>PR 依赖变更审查</td></tr></tbody></table><h3 id="部署工作流示例" tabindex="-1">部署工作流示例 <a class="header-anchor" href="#部署工作流示例" aria-label="Permalink to &quot;部署工作流示例&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .github/workflows/deploy.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deploy to Cloudflare</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    branches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  deploy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/checkout@v4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm/action-setup@v4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/setup-node@v4</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          node-version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm install</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm deploy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          CLOUDFLARE_API_TOKEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ secrets.CF_API_TOKEN }}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="部署架构" tabindex="-1">部署架构 <a class="header-anchor" href="#部署架构" aria-label="Permalink to &quot;部署架构&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户请求 → Cloudflare CDN → Workers (Edge) → KV/D1/R2/外部 API</span></span>
<span class="line"><span>                ↓</span></span>
<span class="line"><span>          全球 300+ 节点</span></span>
<span class="line"><span>          就近响应 &lt; 50ms</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="配额限制" tabindex="-1">配额限制 <a class="header-anchor" href="#配额限制" aria-label="Permalink to &quot;配额限制&quot;">​</a></h2><table tabindex="0"><thead><tr><th>限制项</th><th>免费版</th><th>付费版</th></tr></thead><tbody><tr><td>Worker 脚本大小</td><td>1MB（压缩后）</td><td>10MB</td></tr><tr><td>CPU 时间</td><td>10-50ms</td><td>数秒</td></tr><tr><td>内存</td><td>128MB</td><td>128MB</td></tr><tr><td>子请求数</td><td>50</td><td>1000</td></tr><tr><td>请求持续时间</td><td>30s</td><td>30s</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">参考</p><p>实际限制请查阅 <a href="https://developers.cloudflare.com/workers/platform/limits/" target="_blank" rel="noreferrer">Cloudflare 官方文档</a>。</p></div><h2 id="版本回滚" tabindex="-1">版本回滚 <a class="header-anchor" href="#版本回滚" aria-label="Permalink to &quot;版本回滚&quot;">​</a></h2><p>Cloudflare Pages 保留历史部署，支持以下回滚方式：</p><ol><li><p><strong>Dashboard 回滚</strong>：</p><ul><li>Cloudflare Dashboard → Workers &amp; Pages → 项目 → Deployments</li><li>选择历史版本 → “Rollback to this deployment”</li></ul></li><li><p><strong>重新部署指定提交</strong>：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">commit-has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="cannot-find-module-fs-错误" tabindex="-1">“Cannot find module ‘fs’” 错误 <a class="header-anchor" href="#cannot-find-module-fs-错误" aria-label="Permalink to &quot;“Cannot find module ‘fs’” 错误&quot;">​</a></h3><p>Edge Runtime 不支持 Node.js 内置模块。使用 Web API 替代或确保该代码仅在客户端运行。</p><h3 id="构建体积过大" tabindex="-1">构建体积过大 <a class="header-anchor" href="#构建体积过大" aria-label="Permalink to &quot;构建体积过大&quot;">​</a></h3><ul><li>检查依赖是否有 Node.js 专用代码</li><li>使用动态导入拆分代码</li><li>移除未使用的依赖</li></ul><h3 id="冷启动慢" tabindex="-1">冷启动慢 <a class="header-anchor" href="#冷启动慢" aria-label="Permalink to &quot;冷启动慢&quot;">​</a></h3><ul><li>减少 Worker 脚本体积</li><li>使用 Smart Placement 就近部署</li><li>预热关键路径</li></ul><h2 id="相关链接" tabindex="-1">相关链接 <a class="header-anchor" href="#相关链接" aria-label="Permalink to &quot;相关链接&quot;">​</a></h2><ul><li><a href="https://halolight-cloudflare.h7ml.cn" target="_blank" rel="noreferrer">在线预览 (Cloudflare)</a></li><li><a href="https://halolight.h7ml.cn" target="_blank" rel="noreferrer">在线预览 (原版 Vercel)</a></li><li><a href="https://github.com/halolight/halolight-cloudflare" target="_blank" rel="noreferrer">GitHub 仓库</a></li><li><a href="https://opennext.js.org/cloudflare" target="_blank" rel="noreferrer">OpenNext 文档</a></li><li><a href="https://developers.cloudflare.com/workers/" target="_blank" rel="noreferrer">Cloudflare Workers 文档</a></li></ul>`,70)])])}const b=a(l,[["render",t]]);export{c as __pageData,b as default};
